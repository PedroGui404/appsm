<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Tarefas e Notas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        /* Profile Card Styling */
        .profile-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 2px solid transparent;
        }
        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .profile-card.active {
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
            transform: translateY(-2px);
        }
        .profile-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #6366f1; /* Indigo 500 */
        }

        /* Task Status Chips (for display purposes, not for select) */
        .task-status-chip {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        .status-em-andamento { background-color: #bfdbfe; color: #1e40af; }
        .status-concluida { background-color: #d1fae5; color: #065f46; } /* Updated */
        .status-pausado { background-color: #fefcbf; color: #8a6500; } /* Updated */

        /* Priority Chips */
        .priority-chip {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        .priority-baixa { background-color: #dbeafe; color: #1e40af; }
        .priority-media { background-color: #fef3c7; color: #92400e; }
        .priority-alta { background-color: #fee2e2; color: #991b1b; }

        /* New Date Chips */
        .date-chip {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        .expected-date-chip { background-color: #e0e7ff; color: #4338ca; } /* Indigo 100 / Indigo 700 */
        .expected-date-today-chip { background-color: #fef3c7; color: #92400e; } /* Orange for today's date */
        .expected-date-past-chip { background-color: #fee2e2; color: #991b1b; } /* Red for past date */
        .completed-date-chip { background-color: #d1fae5; color: #065f46; } /* Green 200 / Green 800 (similar to status-concluida but distinct) */


        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            /* Z-index ajustado para aparecer acima do note-app-container */
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            max-height: 90vh; /* Allow modal content to scroll if too tall */
            overflow-y: auto; /* Enable scrolling for modal content */
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Task List Specific Styles */
        #task-list-container, #all-completed-task-list-container {
            max-height: 360px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        .task-list-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background-color: #ffffff;
            transition: opacity 0.3s ease; /* Smooth transition for opacity only */
        }
        .task-list-item:last-child {
            border-bottom: none;
        }
        .task-list-item:hover {
            background-color: #f3f4f6;
        }
        .task-list-item .task-info {
            flex-grow: 1;
            margin-right: 16px;
        }
        .task-list-item .task-actions {
            display: flex;
            gap: 8px; /* Changed to row layout */
            align-items: center; /* Vertically align items */
        }
        .task-list-item .status-select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.875rem;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            min-width: 120px; /* Ensure enough width for text */
            text-align: left; /* Aligned to left */
        }
        /* Styles for the status select colors */
        .status-select-em-andamento { background-color: #bfdbfe; color: #1e40af; }
        .status-select-concluida { background-color: #d1fae5; color: #065f46; }
        .status-select-pausado { background-color: #fefcbf; color: #8a6500; }
        .status-select:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadein 0.5s forwards, fadeout 0.5s 2.5s forwards; /* 3s total duration */
        }
        .toast.success { background-color: #22c55e; } /* Green */
        .toast.error { background-color: #ef4444; }   /* Red */
        .toast.info { background-color: #3b82f6; }    /* Blue */

        @keyframes fadein {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeout {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Animation for new task list items */
        .task-item-enter {
            opacity: 0;
        }
        .task-item-enter-active {
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        /* Note App Specific Styles */
        #note-app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f2f5;
            /* Z-index ajustado para ser menor que o modal-overlay */
            z-index: 2000;
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        #note-app-container.show {
            display: flex;
            opacity: 1;
            visibility: visible;
        }
        #note-sidebar {
            width: 250px;
            background-color: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        #note-content-area {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #note-editor {
            flex-grow: 1;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            font-size: 1rem;
            outline: none;
            resize: vertical; /* Allow vertical resize */
            background-color: #ffffff;
            overflow-y: auto; /* Enable scroll for content */
        }
        .note-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .note-item:hover {
            background-color: #f3f4f6;
        }
        .note-item.active {
            background-color: #e0e7ff; /* Indigo 100 */
            font-weight: 600;
        }
        .note-item-title {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .note-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .note-actions button:hover {
            background-color: #e5e7eb;
        }
        /* Note Toolbar Styles */
        #note-toolbar-wrapper { /* New wrapper for toggle button and collapsible content */
            margin-bottom: 15px;
            background-color: #ffffff; /* Background for the whole toolbar area */
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0; /* Removed padding from wrapper, moved to collapsible */
            overflow: hidden; /* Hide overflow when collapsed */
        }
        #toggle-toolbar-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px; /* Padding for the toggle button itself */
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #4b5563;
        }
        #toggle-toolbar-btn svg {
            transition: transform 0.3s ease;
        }
        #note-toolbar-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* Animate padding too */
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 10px; /* Padding only when expanded */
            padding-bottom: 0; /* Ensure no bottom padding when collapsed */
        }
        #note-toolbar-collapsible.expanded {
            max-height: 200px; /* Sufficient height to show all controls */
            padding-top: 8px; /* Add padding when expanded */
            padding-bottom: 10px; /* Add padding when expanded */
        }
        #note-toolbar-collapsible button, #note-toolbar-collapsible select, #note-toolbar-collapsible input[type="color"] {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: #f9fafb;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #note-toolbar-collapsible button:hover, #note-toolbar-collapsible select:hover {
            background-color: #e5e7eb;
        }
        #note-toolbar-collapsible input[type="color"] {
            width: 40px;
            height: 32px;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="main-app-container" class="container">
        <div class="p-6 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 mb-1">Gerenciador de Tarefas</h1>
            <p class="text-gray-600">Organize suas tarefas por perfil.</p>
        </div>

        <div id="profile-selection" class="p-6 bg-gray-50 border-b border-gray-200 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            </div>

        <div class="p-6 flex-grow">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Minhas Tarefas</h2>
                <div class="flex gap-3 items-center">
                    <button id="show-all-completed-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">
                        Ver Todas Concluídas
                    </button>
                    <button id="add-task-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Adicionar Tarefa
                    </button>
                </div>
            </div>
            <div id="task-list-container" class="rounded-lg shadow-sm">
                <div id="task-list" class="divide-y divide-gray-200">
                    <p id="no-tasks-message" class="col-span-full text-center text-gray-500 py-4 hidden">Nenhuma tarefa para este perfil.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="task-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-800 mb-4">Adicionar Nova Tarefa</h3>
            <form id="task-form" class="space-y-4">
                <div>
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" id="task-title" class="form-input" placeholder="Título da tarefa" required>
                </div>
                <div>
                    <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <textarea id="task-description" class="form-textarea" rows="3" placeholder="Detalhes da tarefa"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="task-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="task-status" class="form-select">
                            <option value="em-andamento">Em Andamento</option>
                            <option value="concluida">Concluída</option>
                            <option value="pausado">Pausado</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                        <select id="task-priority" class="form-select">
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="expected-completion-date" class="block text-sm font-medium text-gray-700 mb-1">Data de Conclusão Esperada</label>
                    <input type="date" id="expected-completion-date" class="form-input">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-task-btn" class="px-4 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-200 ease-in-out">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirmar Ação</h3>
            <p id="confirm-message" class="text-gray-700 mb-6">Tem certeza que deseja realizar esta ação?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="confirm-cancel-btn" class="px-4 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-200 ease-in-out">Cancelar</button>
                <button type="button" id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="all-completed-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Todas as Tarefas Concluídas</h3>
            <div id="all-completed-task-list-container" class="rounded-lg shadow-sm">
                <div id="all-completed-task-list" class="divide-y divide-gray-200">
                    <p id="no-all-completed-tasks-message" class="col-span-full text-center text-gray-500 py-4 hidden">Nenhuma tarefa concluída para este perfil.</p>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" id="close-all-completed-modal-btn" class="px-4 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-200 ease-in-out">Fechar</button>
            </div>
        </div>
    </div>

    <div id="note-app-container" class="absolute w-full h-full flex flex-col md:flex-row rounded-lg shadow-xl overflow-hidden">
        <div id="note-sidebar">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Notas</h3>
            <button id="add-note-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg mb-4 shadow-md">
                Adicionar Nova Nota
            </button>
            <div id="note-list" class="flex-grow overflow-y-auto divide-y divide-gray-200">
                <p id="no-notes-message" class="text-center text-gray-500 py-4 hidden">Nenhuma nota para este perfil.</p>
            </div>
            <button id="close-note-app-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mt-4 shadow-md">
                Fechar Notas
            </button>
        </div>
        <div id="note-content-area">
            <input type="text" id="note-title-input" class="form-input mb-4 text-xl font-semibold" placeholder="Título da Nota">
            <div id="note-toolbar-wrapper">
                <button id="toggle-toolbar-btn">
                    <span>Ferramentas de Formatação</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="note-toolbar-collapsible" class="w-full flex flex-wrap gap-2 pt-2">
                    <select id="font-family-select" class="form-select">
                        <option value="Arial">Arial</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Inter, sans-serif">Inter</option>
                    </select>
                    <select id="font-size-select" class="form-select">
                        <option value="1">12px</option>
                        <option value="2">14px</option>
                        <option value="3" selected>16px</option>
                        <option value="4">18px</option>
                        <option value="5">20px</option>
                        <option value="6">24px</option>
                        <option value="7">28px</option>
                    </select>
                    <button id="bold-btn" class="p-2 border rounded-md hover:bg-gray-100 font-bold">B</button>
                    <button id="italic-btn" class="p-2 border rounded-md hover:bg-gray-100 italic">I</button>
                    <button id="underline-btn" class="p-2 border rounded-md hover:bg-gray-100 underline">U</button>
                    <input type="color" id="font-color-picker" value="#000000">
                </div>
            </div>
            <div id="note-editor" contenteditable="true" class="flex-grow w-full border border-gray-300 rounded-lg p-4 text-base bg-white overflow-y-auto" style="min-height: 200px;"></div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="save-note-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Salvar Nota
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by the user)
        const firebaseConfig = {
            apiKey: "AIzaSyANa-2I5Fwq8h7Xd2YRMI8P8xStkNFMpy0",
            authDomain: "teste-9dc03.firebaseapp.com",
            projectId: "teste-9dc03",
            storageBucket: "teste-9dc03.firebasestorage.app",
            messagingSenderId: "718692523127",
            appId: "1:718692523127:web:8bec2a6c3d807ea39c7a72"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables for app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // DOM Elements
        const mainAppContainer = document.getElementById('main-app-container'); // Main task manager container
        const profileSelectionDiv = document.getElementById('profile-selection');
        const addTaskBtn = document.getElementById('add-task-btn');
        const showAllCompletedBtn = document.getElementById('show-all-completed-btn');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const modalTitle = document.getElementById('modal-title');
        const cancelTaskBtn = document.getElementById('cancel-task-btn');
        const taskList = document.getElementById('task-list');
        const noTasksMessage = document.getElementById('no-tasks-message');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        // New DOM Elements for All Completed Tasks Modal
        const allCompletedModal = document.getElementById('all-completed-modal');
        const allCompletedTaskList = document.getElementById('all-completed-task-list');
        const noAllCompletedTasksMessage = document.getElementById('no-all-completed-tasks-message');
        const closeAllCompletedModalBtn = document.getElementById('close-all-completed-modal-btn');
        const toastContainer = document.getElementById('toast-container');

        // New DOM Elements for Note App
        const noteAppContainer = document.getElementById('note-app-container');
        const addNoteBtn = document.getElementById('add-note-btn');
        const noteList = document.getElementById('note-list');
        const noNotesMessage = document.getElementById('no-notes-message');
        const closeNoteAppBtn = document.getElementById('close-note-app-btn');
        const noteTitleInput = document.getElementById('note-title-input'); // New note title input
        const noteEditor = document.getElementById('note-editor'); // Changed to div contenteditable
        const saveNoteBtn = document.getElementById('save-note-btn');
        const fontFamilySelect = document.getElementById('font-family-select');
        const fontSizeSelect = document.getElementById('font-size-select');
        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const underlineBtn = document.getElementById('underline-btn');
        const fontColorPicker = document.getElementById('font-color-picker');
        const toggleToolbarBtn = document.getElementById('toggle-toolbar-btn'); // New toggle button
        const noteToolbarCollapsible = document.getElementById('note-toolbar-collapsible'); // Collapsible part of toolbar


        // Form Fields (for tasks)
        const taskTitleInputElem = document.getElementById('task-title'); // Renamed to avoid conflict
        const taskDescriptionInput = document.getElementById('task-description');
        const taskStatusSelect = document.getElementById('task-status');
        const taskPrioritySelect = document.getElementById('task-priority');
        const expectedCompletionDateInput = document.getElementById('expected-completion-date');

        // App State
        let currentProfileId = null;
        let editingTaskId = null;
        let unsubscribeFromTasks = null;
        let currentNoteId = null;
        let unsubscribeFromNotes = null;


        // Pre-defined profiles data (hardcoded)
        const profilesData = [
            {
                id: 'bianca',
                name: 'Bianca',
                role: 'Gerente de Projetos',
                photo: 'https://placehold.co/80x80/a78bfa/ffffff?text=BI'
            },
            {
                id: 'pedro',
                name: 'Pedro',
                role: 'Desenvolvedor Sênior',
                photo: 'https://placehold.co/80x80/60a5fa/ffffff?text=PE'
            },
            {
                id: 'gizelle',
                name: 'Gizelle',
                role: 'Designer UX/UI',
                photo: 'https://placehold.co/80x80/f472b6/ffffff?text=GI'
            }
        ];

        // --- Firebase Authentication and Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Usuário autenticado:", user.uid);
                renderProfiles();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Erro ao autenticar no Firebase:", error);
                    showToast("Erro ao autenticar no Firebase.", "error");
                }
            }
        });

        // --- Utility Functions ---

        // Function to get the Firestore collection path for tasks
        function getTasksCollectionRef() {
            if (!currentProfileId) {
                console.error("Nenhum perfil selecionado. Não é possível acessar o Firestore.");
                return null;
            }
            // Updated path for tasks: artifacts/{appId}/public/data/profiles/{profileId}/tasks
            return collection(db, `artifacts/${appId}/public/data/profiles/${currentProfileId}/tasks`);
        }

        // Function to get the Firestore collection path for notes
        function getNotesCollectionRef() {
            if (!currentProfileId) {
                console.error("Nenhum perfil selecionado. Não é possível acessar notas no Firestore.");
                return null;
            }
            // Updated path for notes: artifacts/{appId}/public/data/profiles/{profileId}/notes
            return collection(db, `artifacts/${appId}/public/data/profiles/${currentProfileId}/notes`);
        }

        // Get today's date in YYYY-MM-DD format
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Check if a date string is today's date
        function isToday(dateString) {
            if (!dateString) return false;
            return dateString === getTodayDateString();
        }

        // Check if a date string is in the past
        function isPastDate(dateString) {
            if (!dateString) return false;
            const today = new Date(getTodayDateString()); // Normalize to start of today
            const checkDate = new Date(dateString);
            return checkDate.getTime() < today.getTime();
        }

        // Show modal (reusable for all modals)
        function showModal(modalElement) {
            modalElement.classList.add('show');
        }

        // Hide modal (reusable for all modals)
        function hideModal(modalElement) {
            modalElement.classList.remove('show');
        }

        // Reset task form fields
        function resetTaskForm() {
            taskTitleInputElem.value = '';
            taskDescriptionInput.value = '';
            taskStatusSelect.value = 'em-andamento';
            taskPrioritySelect.value = 'baixa';
            expectedCompletionDateInput.value = '';
            editingTaskId = null;
            modalTitle.textContent = 'Adicionar Nova Tarefa';
        }

        // Display a toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // --- Profile Management Functions ---

        // Renders profile cards to the UI
        function renderProfiles() {
            profileSelectionDiv.innerHTML = '';
            profilesData.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.id = `profile-card-${profile.id}`;
                profileCard.className = `profile-card bg-white p-4 rounded-lg shadow-md flex flex-col items-center text-center`;
                profileCard.innerHTML = `
                    <img class="profile-image mb-2" src="${profile.photo}" alt="Foto de ${profile.name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/000000?text=?'">
                    <h3 class="text-lg font-semibold text-gray-800">${profile.name}</h3>
                    <p class="text-sm text-gray-600">${profile.role}</p>
                    <button data-profile-id="${profile.id}" class="open-notes-btn mt-3 p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    </button>
                `;
                profileCard.addEventListener('click', (e) => {
                    if (!e.target.closest('.open-notes-btn')) {
                        selectProfile(profile.id);
                    }
                });
                profileSelectionDiv.appendChild(profileCard);
            });

            document.querySelectorAll('.open-notes-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const profileId = e.currentTarget.dataset.profileId;
                    openNoteApp(profileId);
                });
            });
        }

        // Selects a profile and loads its tasks
        function selectProfile(profileId) {
            currentProfileId = profileId;

            document.querySelectorAll('.profile-card').forEach(card => {
                card.classList.remove('active');
            });
            const selectedProfileCard = document.getElementById(`profile-card-${profileId}`);
            if (selectedProfileCard) {
                selectedProfileCard.classList.add('active');
            }

            loadTasks(currentProfileId);
        }

        // --- Task Management Functions ---

        // Add a new task
        async function addTask(task) {
            const tasksCollectionRef = getTasksCollectionRef();
            if (!tasksCollectionRef) return;
            try {
                await addDoc(tasksCollectionRef, {
                    ...task,
                    profileId: currentProfileId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                showToast("Tarefa adicionada com sucesso!", "success");
            } catch (e) {
                console.error("Erro ao adicionar tarefa: ", e);
                showToast("Erro ao adicionar tarefa.", "error");
            }
        }

        // Update an existing task
        async function updateTask(id, updates) {
            const tasksCollectionRef = getTasksCollectionRef();
            if (!tasksCollectionRef) return;
            try {
                const taskDocRef = doc(tasksCollectionRef, id);
                await updateDoc(taskDocRef, {
                    ...updates,
                    updatedAt: new Date()
                });
                showToast("Tarefa atualizada com sucesso!", "success");
            } catch (e) {
                console.error("Erro ao atualizar tarefa: ", e);
                showToast("Erro ao atualizar tarefa.", "error");
            }
        }

        // Delete a task
        async function deleteTask(id) {
            const tasksCollectionRef = getTasksCollectionRef();
            if (!tasksCollectionRef) return;
            try {
                const taskDocRef = doc(tasksCollectionRef, id);
                await deleteDoc(taskDocRef);
                showToast("Tarefa excluída com sucesso!", "success");
            } catch (e) {
                console.error("Erro ao excluir tarefa: ", e);
                showToast("Erro ao excluir tarefa.", "error");
            }
        }

        // Update task status from the select dropdown
        async function updateTaskStatusFromSelect(taskId, newStatus) {
            const updates = { status: newStatus };
            if (newStatus === 'concluida') {
                updates.dateCompleted = getTodayDateString();
            } else {
                updates.dateCompleted = null;
            }
            await updateTask(taskId, updates);
        }

        // Load tasks from Firestore for the current profile (main list - filtered)
        async function loadTasks(profileId) {
            if (unsubscribeFromTasks) {
                unsubscribeFromTasks();
            }

            const tasksCollectionRef = getTasksCollectionRef();
            if (!tasksCollectionRef) {
                taskList.innerHTML = '';
                noTasksMessage.classList.remove('hidden');
                return;
            }

            const q = query(
                tasksCollectionRef,
                where("profileId", "==", profileId)
            );

            unsubscribeFromTasks = onSnapshot(q, (snapshot) => {
                let allTasks = [];
                snapshot.forEach((doc) => {
                    allTasks.push({ id: doc.id, ...doc.data() });
                });

                allTasks.sort((a, b) => {
                    const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate() : (a.createdAt instanceof Date ? a.createdAt : new Date(0));
                    const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate() : (b.createdAt instanceof Date ? b.createdAt : new Date(0));
                    return dateB.getTime() - dateA.getTime();
                });

                let filteredTasks = allTasks.filter(task => {
                    return task.status !== 'concluida' || (task.status === 'concluida' && isToday(task.dateCompleted));
                });

                renderTasks(filteredTasks, taskList, noTasksMessage, true);
            }, (error) => {
                console.error("Erro ao carregar tarefas:", error);
                showToast("Erro ao carregar tarefas.", "error");
                taskList.innerHTML = '<p class="text-red-500 col-span-full py-4">Erro ao carregar tarefas.</p>';
                noTasksMessage.classList.add('hidden');
            });
        }

        // Load ALL completed tasks for the modal
        async function loadAllCompletedTasksForModal(profileId) {
            const tasksCollectionRef = getTasksCollectionRef();
            if (!tasksCollectionRef) return;

            const q = query(
                tasksCollectionRef,
                where("profileId", "==", profileId),
                where("status", "==", "concluida")
            );
            try {
                const querySnapshot = await getDocs(q);
                const completedTasks = [];
                querySnapshot.forEach((doc) => {
                    completedTasks.push({ id: doc.id, ...doc.data() });
                });

                completedTasks.sort((a, b) => {
                    const dateA = a.dateCompleted ? new Date(a.dateCompleted) : new Date(0);
                    const dateB = b.dateCompleted ? new Date(b.dateCompleted) : new Date(0);
                    return dateB.getTime() - dateA.getTime();
                });

                renderTasks(completedTasks, allCompletedTaskList, noAllCompletedTasksMessage, false);
            } catch (error) {
                console.error("Erro ao carregar todas as tarefas concluídas:", error);
                showToast("Erro ao carregar todas as tarefas concluídas.", "error");
                allCompletedTaskList.innerHTML = '<p class="text-red-500 col-span-full py-4">Erro ao carregar tarefas concluídas.</p>';
                noAllCompletedTasksMessage.classList.add('hidden');
            }
        }

        // Render tasks to a given list element
        function renderTasks(tasks, targetListElement, targetNoTasksMessageElement, includeActions) {
            targetListElement.innerHTML = '';

            if (tasks.length === 0) {
                targetNoTasksMessageElement.classList.remove('hidden');
                return;
            } else {
                targetNoTasksMessageElement.classList.add('hidden');
            }

            tasks.forEach(task => {
                const taskListItem = document.createElement('div');
                taskListItem.className = `task-list-item task-item-enter`;
                taskListItem.innerHTML = `
                    <div class="task-info">
                        <h3 class="text-lg font-medium text-gray-800">${task.title}</h3>
                        <p class="text-gray-600 text-sm">${task.description || 'Sem descrição'}</p>
                        <div class="flex items-center flex-wrap gap-2 mt-2">
                            <span class="priority-chip priority-${task.priority}" data-priority="${task.priority}">${getDisplayPriority(task.priority)}</span>
                            ${task.expectedCompletionDate ? `<span class="date-chip ${isToday(task.expectedCompletionDate) ? 'expected-date-today-chip' : (isPastDate(task.expectedCompletionDate) ? 'expected-date-past-chip' : 'expected-date-chip')}">Concluir até: ${formatDateDisplay(task.expectedCompletionDate)}</span>` : ''}
                            ${task.status === 'concluida' && task.dateCompleted ? `<span class="date-chip completed-date-chip">Concluída em: ${formatDateDisplay(task.dateCompleted)}</span>` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        ${includeActions ? `
                            <select data-id="${task.id}" class="status-select ${getStatusSelectClass(task.status)}">
                                <option value="em-andamento" ${task.status === 'em-andamento' ? 'selected' : ''}>Em Andamento</option>
                                <option value="concluida" ${task.status === 'concluida' ? 'selected' : ''}>Concluída</option>
                                <option value="pausado" ${task.status === 'pausado' ? 'selected' : ''}>Pausado</option>
                            </select>
                            <button data-id="${task.id}" data-action="edit" class="edit-task-btn p-2 rounded-full text-indigo-600 hover:bg-indigo-100 transition duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button data-id="${task.id}" data-action="delete" class="delete-task-btn p-2 rounded-full text-red-600 hover:bg-red-100 transition duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 2 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        ` : ''}
                    </div>
                `;
                targetListElement.appendChild(taskListItem);

                setTimeout(() => {
                    taskListItem.classList.add('task-item-enter-active');
                }, 10);
            });

            if (includeActions) {
                addTaskListEventListeners();
            }
        }

        // Helper to format date for display (e.g., YYYY-MM-DD to DD/MM/YYYY)
        function formatDateDisplay(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // Helper to get status select class for styling
        function getStatusSelectClass(status) {
            switch (status) {
                case 'em-andamento': return 'status-select-em-andamento';
                case 'concluida': return 'status-select-concluida';
                case 'pausado': return 'status-select-pausado';
                default: return '';
            }
        }

        // Helper to get display priority text
        function getDisplayPriority(priority) {
            switch (priority) {
                case 'baixa': return 'Prioridade Baixa';
                case 'media': return 'Prioridade Média';
                case 'alta': return 'Prioridade Alta';
                default: return priority;
            }
        }

        // --- Note App Functions ---

        // Open the note app for a specific profile
        function openNoteApp(profileId) {
            if (!profileId) {
                showToast("Selecione um perfil para abrir o aplicativo de notas.", "error");
                return;
            }
            currentProfileId = profileId; // Ensure currentProfileId is set for notes
            mainAppContainer.style.display = 'none'; // Hide task manager
            noteAppContainer.classList.add('show'); // Show note app
            loadNotes(profileId);
            resetNoteEditor();
            // Ensure contentEditable is active
            noteEditor.focus();
            document.execCommand('styleWithCSS', false, true); // Use inline CSS for formatting
        }

        // Close the note app
        closeNoteAppBtn.addEventListener('click', () => {
            noteAppContainer.classList.remove('show'); // Hide note app
            mainAppContainer.style.display = 'flex'; // Show task manager
            if (unsubscribeFromNotes) {
                unsubscribeFromNotes(); // Unsubscribe from notes listener
            }
            currentNoteId = null; // Clear current note
            resetNoteEditor(); // Reset editor state
        });

        // Load notes from Firestore for the current profile
        async function loadNotes(profileId) {
            if (unsubscribeFromNotes) {
                unsubscribeFromNotes();
            }

            const notesCollectionRef = getNotesCollectionRef();
            if (!notesCollectionRef) {
                noteList.innerHTML = '';
                noNotesMessage.classList.remove('hidden');
                return;
            }

            const q = query(notesCollectionRef, where("profileId", "==", profileId)); // Filter notes by profileId

            unsubscribeFromNotes = onSnapshot(q, (snapshot) => {
                const notes = [];
                snapshot.forEach(doc => {
                    notes.push({ id: doc.id, ...doc.data() });
                });
                // Sort notes by creation date, newest first
                notes.sort((a, b) => {
                    const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate() : (a.createdAt instanceof Date ? a.createdAt : new Date(0));
                    const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate() : (b.createdAt instanceof Date ? b.createdAt : new Date(0));
                    return dateB.getTime() - dateA.getTime();
                });
                renderNotes(notes);
            }, (error) => {
                console.error("Erro ao carregar notas:", error);
                showToast("Erro ao carregar notas.", "error");
                noteList.innerHTML = '<p class="text-red-500 col-span-full py-4">Erro ao carregar notas.</p>';
                noNotesMessage.classList.add('hidden');
            });
        }

        // Render notes in the sidebar list
        function renderNotes(notes) {
            noteList.innerHTML = '';
            if (notes.length === 0) {
                noNotesMessage.classList.remove('hidden');
                return;
            } else {
                noNotesMessage.classList.add('hidden');
            }

            notes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = `note-item ${currentNoteId === note.id ? 'active' : ''}`;
                noteItem.dataset.id = note.id;
                noteItem.innerHTML = `
                    <span class="note-item-title">${note.title || 'Nova Nota'}</span>
                    <div class="note-actions">
                        <button class="delete-note-btn" data-id="${note.id}">
                            <svg class="w-4 h-4 text-gray-500 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 2 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                noteItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-note-btn')) {
                        selectNote(note.id, note.content || '', note.styles || {}, note.title || 'Nova Nota');
                    }
                });
                noteList.appendChild(noteItem);
            });

            // Attach delete note listeners
            noteList.querySelectorAll('.delete-note-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const noteId = e.currentTarget.dataset.id;
                    showConfirmModal("Tem certeza que deseja excluir esta nota?", async () => {
                        await deleteNote(noteId);
                        hideModal(confirmModal); // Esconde o modal de confirmação após a ação
                    });
                });
            });
        }

        // Select a note to edit
        function selectNote(noteId, content, styles, title) {
            currentNoteId = noteId;
            noteTitleInput.value = title; // Set the title input
            noteEditor.innerHTML = content; // Set innerHTML for contenteditable
            applyStylesToEditor(styles); // Apply saved styles to editor (initial state)

            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
            });
            const selectedNoteItem = document.querySelector(`.note-item[data-id="${noteId}"]`);
            if (selectedNoteItem) {
                selectedNoteItem.classList.add('active');
            }
            noteEditor.focus(); // Focus editor for immediate typing
        }

        // Reset note editor
        function resetNoteEditor() {
            currentNoteId = null;
            noteTitleInput.value = ''; // Clear title input
            noteEditor.innerHTML = ''; // Clear contenteditable
            // Reset default styles
            noteEditor.style.cssText = '';
            fontFamilySelect.value = 'Inter, sans-serif';
            fontSizeSelect.value = '3'; // Default to 16px (size 3)
            fontColorPicker.value = '#000000';
            // Ensure contentEditable is active for new notes
            document.execCommand('styleWithCSS', false, true);
        }

        // Add a new note
        addNoteBtn.addEventListener('click', () => {
            resetNoteEditor();
            showToast("Comece a escrever sua nova nota!", "info");
            noteEditor.focus(); // Focus editor for immediate typing
        });

        // Save/Update note
        saveNoteBtn.addEventListener('click', async () => {
            const title = noteTitleInput.value.trim() || 'Nova Nota'; // Use title input value
            const content = noteEditor.innerHTML; // Get HTML content from contenteditable

            const notesCollectionRef = getNotesCollectionRef();
            if (!notesCollectionRef) return;

            if (currentNoteId) {
                try {
                    await updateDoc(doc(notesCollectionRef, currentNoteId), {
                        title: title,
                        content: content,
                        updatedAt: new Date()
                    });
                    showToast("Nota atualizada com sucesso!", "success");
                } catch (e) {
                    console.error("Erro ao atualizar nota:", e);
                    showToast("Erro ao atualizar nota.", "error");
                }
            } else {
                try {
                    const newNoteRef = await addDoc(notesCollectionRef, {
                        title: title,
                        content: content,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        profileId: currentProfileId
                    });
                    currentNoteId = newNoteRef.id;
                    showToast("Nota salva com sucesso!", "success");
                    loadNotes(currentProfileId); // Reload notes to show the new one and mark it active
                } catch (e) {
                    console.error("Erro ao salvar nota:", e);
                    showToast("Erro ao salvar nota.", "error");
                }
            }
        });

        // Delete a note
        async function deleteNote(noteId) {
            const notesCollectionRef = getNotesCollectionRef();
            if (!notesCollectionRef) return;
            try {
                await deleteDoc(doc(notesCollectionRef, noteId));
                showToast("Nota excluída com sucesso!", "success");
                if (currentNoteId === noteId) {
                    resetNoteEditor();
                }
            } catch (e) {
                console.error("Erro ao excluir nota:", e);
                showToast("Erro ao excluir nota.", "error");
            }
        }

        // --- Text Formatting Functions (for contenteditable div) ---
        function applyFormatting(command, value = null) {
            document.execCommand(command, false, value);
            noteEditor.focus();
        }

        fontFamilySelect.addEventListener('change', (e) => applyFormatting('fontName', e.target.value));
        fontSizeSelect.addEventListener('change', (e) => applyFormatting('fontSize', e.target.value));
        fontColorPicker.addEventListener('input', (e) => applyFormatting('foreColor', e.target.value));

        boldBtn.addEventListener('click', () => applyFormatting('bold'));
        italicBtn.addEventListener('click', () => applyFormatting('italic'));
        underlineBtn.addEventListener('click', () => applyFormatting('underline'));

        function applyStylesToEditor(styles) {
            // These are initial/default styles for the editor itself, not individual text selections
            // For contenteditable, styles are mostly inline within the HTML.
            // We can set default styles for the editor itself here if needed.
            // For example, if a note didn't have specific styles saved, it would default to these.
            noteEditor.style.fontFamily = styles.fontFamily || 'Inter, sans-serif';
            noteEditor.style.fontSize = styles.fontSize || '16px'; // Note: execCommand uses 1-7
            noteEditor.style.color = styles.color || '#000000';

            // Update toolbar selects/pickers to reflect loaded styles (if applicable)
            // This part is tricky because contenteditable doesn't expose a single 'current font'
            // unless the entire content has the same style.
            // For simplicity, we'll just set the dropdowns to the default or last applied.
            fontFamilySelect.value = noteEditor.style.fontFamily;
            fontSizeSelect.value = '3'; // Default to 16px (size 3) for the dropdown
            fontColorPicker.value = '#000000'; // Default color
        }

        // Toggle toolbar visibility
        toggleToolbarBtn.addEventListener('click', () => {
            noteToolbarCollapsible.classList.toggle('expanded');
            const isExpanded = noteToolbarCollapsible.classList.contains('expanded');
            toggleToolbarBtn.querySelector('svg').style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
        });


        // --- Event Listeners Setup (Tasks) ---

        addTaskBtn.addEventListener('click', () => {
            resetTaskForm();
            showModal(taskModal);
        });

        showAllCompletedBtn.addEventListener('click', () => {
            if (!currentProfileId) {
                showToast("Selecione um perfil primeiro para ver as tarefas concluídas.", "info");
                return;
            }
            loadAllCompletedTasksForModal(currentProfileId);
            showModal(allCompletedModal);
        });

        closeAllCompletedModalBtn.addEventListener('click', () => {
            hideModal(allCompletedModal);
        });

        cancelTaskBtn.addEventListener('click', () => {
            hideModal(taskModal);
        });

        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = taskTitleInputElem.value.trim();
            const description = taskDescriptionInput.value.trim();
            const status = taskStatusSelect.value;
            const priority = taskPrioritySelect.value;
            const expectedCompletionDate = expectedCompletionDateInput.value;

            if (!title) {
                alert("O título da tarefa não pode estar vazio.");
                return;
            }

            const taskData = { title, description, status, priority, expectedCompletionDate };

            if (status === 'concluida') {
                taskData.dateCompleted = getTodayDateString();
            } else {
                taskData.dateCompleted = null;
            }

            if (editingTaskId) {
                await updateTask(editingTaskId, taskData);
            } else {
                if (!currentProfileId) {
                    showToast("Selecione um perfil para adicionar a tarefa.", "error");
                    hideModal(taskModal);
                    return;
                }
                await addTask(taskData);
            }

            hideModal(taskModal);
            resetTaskForm();
        });

        function addTaskListEventListeners() {
            taskList.querySelectorAll('.status-select').forEach(select => {
                select.onchange = (e) => {
                    const taskId = e.target.dataset.id;
                    const newStatus = e.target.value;
                    e.target.className = `status-select ${getStatusSelectClass(newStatus)}`;
                    updateTaskStatusFromSelect(taskId, newStatus);
                };
            });

            taskList.querySelectorAll('.edit-task-btn').forEach(button => {
                button.onclick = async (e) => {
                    const taskId = e.currentTarget.dataset.id;
                    const tasksCollectionRef = getTasksCollectionRef();
                    if (!tasksCollectionRef) return;

                    try {
                        const taskDoc = await getDoc(doc(tasksCollectionRef, taskId));
                        if (taskDoc.exists()) {
                            const taskData = taskDoc.data();
                            taskTitleInputElem.value = taskData.title;
                            taskDescriptionInput.value = taskData.description;
                            taskStatusSelect.value = taskData.status;
                            taskPrioritySelect.value = taskData.priority;
                            expectedCompletionDateInput.value = taskData.expectedCompletionDate || '';
                            editingTaskId = taskId;
                            modalTitle.textContent = 'Editar Tarefa';
                            showModal(taskModal);
                        } else {
                            console.error("Tarefa não encontrada para edição.");
                            showToast("Tarefa não encontrada para edição.", "error");
                        }
                    }
                    catch (error) {
                        console.error("Erro ao buscar tarefa para edição:", error);
                        showToast("Erro ao buscar tarefa para edição.", "error");
                    }
                };
            });

            taskList.querySelectorAll('.delete-task-btn').forEach(button => {
                button.onclick = (e) => {
                    const taskId = e.currentTarget.dataset.id;
                    showConfirmModal("Tem certeza que deseja excluir esta tarefa?", async () => {
                        await deleteTask(taskId);
                        hideModal(confirmModal); // Hide confirm modal after action
                    });
                };
            });
        }

        // --- Confirmation Modal Logic ---
        let confirmActionCallback = null;

        function showConfirmModal(message, callback) {
            confirmMessage.textContent = message;
            confirmActionCallback = callback;
            showModal(confirmModal);
        }

        confirmCancelBtn.addEventListener('click', () => {
            hideModal(confirmModal);
            confirmActionCallback = null;
        });

        confirmActionBtn.addEventListener('click', () => {
            if (confirmActionCallback) {
                confirmActionCallback();
            }
        });

        // Close modals if clicked outside
        taskModal.addEventListener('click', (e) => {
            if (e.target === taskModal) {
                hideModal(taskModal);
            }
        });

        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                hideModal(confirmModal);
            }
        });

        allCompletedModal.addEventListener('click', (e) => {
            if (e.target === allCompletedModal) {
                hideModal(allCompletedModal);
            }
        });
    </script>
</body>
</html>
